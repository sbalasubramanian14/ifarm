/*
 *
 * jQuery Linked Selects Plugin
 * 2016-12-24
 *
 * Copyright 2016 Bogac Bokeer
 * Licensed under the MIT license
 *
 */
!(function(a,b){'use strict';if(typeof define==='function'&&define.amd){define(['jquery'],b)}else if(typeof exports==='object'){module.exports=b(require('jquery'))}else{b(a.jQuery)}}(this,function($){'use strict';var j='bbLinkedSelect';var k=(function(){var e=function(a,b,c){if(!a||typeof a!=='string'){return null}b=b||null;c=c||window;a=a.split('.');var d=false,prop,subns;while(a.length>1&&(typeof c==='object')){subns=a.shift();prop=a;c=c[subns]}if(typeof c==='object'){a=a.shift();prop=a;a=c[a];d=b?typeof a===b:typeof a!=='undefined'}e.lastKey=d?{o:c,prop:prop}:null;e.lastValue=d?a:null;return d};e.lastKey=null;e.lastValue=null;e.setLastKey=function(a){var b,prop,r;if(e.lastKey&&(b=e.lastKey.o)&&(prop=e.lastKey.prop)){r=b[prop]=a}return r};return e}()),isInteger=function(a){return Number(a)===a&&a%1===0},isFloat=function(a){return a===+a&&a!==(a|0)},isString=function(a){return $.type(a)==='string'},hasOwn=function(a,b){return Object.prototype.hasOwnProperty.call(a,b)};$.linkedSelect={options:{attrTarget:'data-select-target',attrService:'data-select-service',attrFilter:'data-select-service-asfilter',attrMap:'data-select-map',method:'POST',onBeforeSend:function(){},onBeforeFill:function(){},onAfterFill:function(){}},extension:{service:{_default:'ajax',variable:function(a){if(!k(a.name)){return false}var p=$.Deferred();p.resolve({result:true,items:k.lastValue});return p},ajax:function(a){var b=a.name.split('|');var c=b[0].trim()||location.href,serviceMethod=b[1]||'POST';return $.ajax({url:c,type:serviceMethod,dataType:'json',data:a.data})}},filter:{_default:'all',filter1:function(c){c=c.name;var d=$.linkedSelect,filterFn=false;if(c&&/^[0-9a-z_]+$/i.test(c)){filterFn=function(a,b){return a[c]===this.value||d.castData(this.value)===d.castData(a[c])}}return filterFn},expressions:function(a){return a.name?new Function('item','index','return '+a.name):false},all:function(a){return function(){return true}}},map:{_default:'asIs',asIs:function(a){return a}}},applyData:function(a,b){var c=this,dataSend=$.extend(true,{},b),fns=c.settings[b.type]||null;if(dataSend.named){dataSend.callName=dataSend.name;dataSend.name=dataSend.named}fns&&$.isFunction(fns.onBeforeSend)&&fns.onBeforeSend(a,dataSend.data,dataSend.name,$.extend(true,{},c.settings),c);return dataSend||b},getExtData:function(a,b,c){var d=this,fn,dataSend,extData;if($.isFunction(fn=b[a])){if(!c.raw){dataSend=d.applyData(a,c);if(extData=fn.call(d,dataSend||c)){return extData}}else{return fn}}return null},getExtension:function(a,b){b=b||null;var c=this,extensions=c.extension[a],named=(b&&b.name&&b.name[0]==='@')?b.name.substr(1):false,extData=null,ext;b.type=a;b.named=named;if(named){if(extData=c.getExtData(named,extensions,b)){return extData}}if(a==='map'&&!named){return null}for(ext in extensions){if(hasOwn(extensions,ext)&&ext!=='_default'&&ext!==extensions._default){if(extData=c.getExtData(ext,extensions,b)){return extData}}}var d=c.applyData(extensions._default,b);return extensions[extensions._default].call(c,d)||extData},addFilter:function(a,b){return $.linkedSelect.extension.filter[a]=b},addMap:function(a,b){return $.linkedSelect.extension.map[a]=b},add:function(a){var b=this,extensions=b.extension,extensionType;for(extensionType in a){if(hasOwn(extensions,extensionType)&&hasOwn(a,extensionType)){for(name in a[extensionType]){if(hasOwn(a[extensionType],name)){extensions[extensionType][name]=a[extensionType][name]}}}}return b.extension},castData:function(a){if(typeof a==='undefined'){return undefined}if(isString(a)){if(a.toLowerCase()==='true'){return true}if(a.toLowerCase()==='false'){return false}}if(isFloat(a)){return parseFloat(a)}if(isInteger(a)){return parseInt(a,10)}return a},getServiceData:function(a,b){return this.getExtension('service',{name:a,data:b})},getFilter:function(a,b,c){var d=this,filterData=d.getExtension('filter',{name:b});if(!!filterData){filterData.value=d.castData(a);filterData.filter=b;filterData.extraData=c||null;filterData=$.proxy(filterData,c.source[0])}return filterData},getData:function(a,b,c,d){c=c||null;if(!c){return a}var e=this;var f=a,filterFn=e.getFilter(b,c.filter,d),mapFn=e.getExtension('map',{name:c.map,raw:true});if(filterFn){f=f.filter(filterFn)}if(mapFn){f=f.map(mapFn)}return f},getSelectInfo:function(a){if(!a){return null}var b={targetName:a.attr(this.settings.attrTarget),service:a.attr(this.settings.attrService)?a.attr(this.settings.attrService):false,value:a.val(),$target:null};b.$target=$('select[name='+b.targetName+']');return b},addOption:function(a,b,c,d){c=c||'';d=d||false;var e=document.createElement('option');e.text=b;e.value=c;if(!!d){e.selected=true}a.appendChild(e);return e},emptySelect:function(a,b,c){if(!a||!a.length){return a}var d=this;b=b||false;c=c||false;var e=b?0:1;if(a.find('option').length<=e){return a}while(a.find('option').length>e){a.find('option').eq(1).off().remove()}if($.isPlainObject(b)){this.addOption(a[0],b.text,b.value)}d.settings&&$.isFunction(d.settings.onAfterFill)&&d.settings.onAfterFill.call(null,a);if(c&&a&&a.length){d.emptySelect(d.getSelectInfo(a).$target,false,c)}return a},fillData:function(a,b,c){var d=this,options=d.settings;options&&$.isFunction(options.onBeforeFill)&&options.onBeforeFill.call(null,a,b,c);d.emptySelect(b,false);if(a){c&&$.each(c,function(){d.addOption(b[0],this.text,this.value,this.selected)});options&&$.isFunction(options.onAfterFill)&&options.onAfterFill.call(null,b,a,c)}d.emptySelect(d.getSelectInfo(b).$target,false,true)},reset:function(c){var d=this,targets={},targetName,isValueOption=function(){return!!this.value&&this.value.trim()!==''};c.each(function(){targetName=d.getSelectInfo($(this)).targetName;targets[targetName]=$('select[name='+targetName+']')});$.each(targets,function(a){var b=$(this).find('option');if(b.length<2&&!b.filter(isValueOption).length){d.emptySelect($(this),false)}});targets=null},isExists:k,isInteger:isInteger,isFloat:isFloat,isString:isString,itemInit:function(d){var f=this,options=f.settings;var g=$(d),selectInfo=f.getSelectInfo(g),filter=g.attr(options.attrFilter)||false,map=g.attr(options.attrMap)||false,value=selectInfo.value;var h={source:g,target:selectInfo.$target,service:selectInfo.service};var i=(!filter&&!map)?null:{filter:filter||false,map:map||false};g.on('change',function(e){if(i&&g.data(j+'_filter')){var c=f.getData(g.data(j+'_filter'),value,i,h);f.fillData(g,selectInfo.$target,c)}else{f.getServiceData(selectInfo.service,{field:g.attr('name'),target:selectInfo.targetName,value:value},options.method).done(function(a){if(a.result){var b=a.items;if(i){g.data(j+'_filter',b);b=f.getData(b,value,i,h)}f.fillData(g,selectInfo.$target,b)}})}}).addClass(j+'-init')},setOptions:function(a){var b=$.linkedSelect;b.settings=$.extend({},b.options,a);return b.settings},init:function(a){var b=$.linkedSelect;b.setOptions(a);$('['+b.settings.attrTarget+']').linkedSelect()}};$.fn.linkedSelect=function(){var a=$.linkedSelect;a.reset(this);return this.not('.'+j+'-init').each(function(){a.itemInit(this)})}}));
